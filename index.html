<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√≥a ƒê∆°n B√°n H√†ng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif; /* Thay ƒë·ªïi font cho hi·ªán ƒë·∫°i h∆°n */
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
            padding: 20px;
        }
        .invoice-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            border: 1px solid #ddd;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 24px;
            text-transform: uppercase;
            color: #222;
        }
        .header .invoice-id {
            font-size: 14px;
            color: #555;
            margin-top: 5px;
        }
        .info-section {
            border-top: 2px solid #333;
            border-bottom: 2px solid #333;
            padding: 15px 0;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
        }
        .info-section div {
            width: 48%;
        }
        .info-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .info-section p {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .info-section .label {
            font-weight: bold;
            display: inline-block;
            min-width: 100px;
        }
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        .items-table th, .items-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .items-table th {
            background-color: #f8f8f8;
            font-weight: bold;
            text-align: center;
        }
        .items-table td:nth-child(2),
        .items-table td:nth-child(3),
        .items-table td:nth-child(4) {
            text-align: right;
        }
        .totals-section {
            display: flex;
            justify-content: flex-end;
        }
        .totals-section table {
            width: 50%;
            border-collapse: collapse;
        }
        .totals-section td {
            padding: 10px;
            font-size: 14px;
        }
        .totals-section .label {
            font-weight: bold;
            text-align: right;
        }
        .totals-section .total-amount {
            font-size: 18px;
            font-weight: bold;
            color: #dc3545; /* M√†u ƒë·ªè cho n·ªïi b·∫≠t */
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            font-style: italic;
            color: #777;
        }
        .buttons {
            text-align: center;
            margin: 20px 0;
        }
        .btn {
            background-color: #007bff; color: white; padding: 10px 20px;
            border: none; border-radius: 5px; cursor: pointer;
            font-size: 14px; margin: 0 5px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-success { background-color: #28a745; }
        .btn-info { background-color: #17a2b8; }

        @media print {
            body { background-color: white; padding: 0; }
            .invoice-container { box-shadow: none; border: none; max-width: none; margin: 0; padding: 10px; }
            .buttons { display: none; }
        }
    </style>
</head>
<body>
    <div class="invoice-container" id="printArea">
        <div class="header">
            <h1>H√≥a ƒê∆°n B√°n H√†ng</h1>
            <p class="invoice-id">M√£ H√≥a ƒê∆°n: <span id="maHoaDon"></span></p>
        </div>

        <div class="info-section">
            <div class="store-info">
                <h3>TH√îNG TIN C·ª¨A H√ÄNG</h3>
                <p><span class="label">T√™n c·ª≠a h√†ng:</span> [ƒêi·ªÅn t√™n c·ª≠a h√†ng c·ªßa b·∫°n]</p>
                <p><span class="label">ƒê·ªãa ch·ªâ:</span> [ƒêi·ªÅn ƒë·ªãa ch·ªâ c·ªßa b·∫°n]</p>
                <p><span class="label">S·ªë ƒëi·ªán tho·∫°i:</span> [ƒêi·ªÅn SƒêT c·ªßa b·∫°n]</p>
            </div>
            <div class="customer-info">
                <h3>TH√îNG TIN KH√ÅCH H√ÄNG</h3>
                <p><span class="label">T√™n kh√°ch h√†ng:</span> <span id="tenKH"></span></p>
                <p><span class="label">S·ªë ƒëi·ªán tho·∫°i:</span> <span id="sdtKH"></span></p>
                <p><span class="label">ƒê·ªãa ch·ªâ:</span> <span id="diaChiKH"></span></p>
                <p><span class="label">Ng√†y mua:</span> <span id="ngayMua"></span></p>
            </div>
        </div>

        <table class="items-table">
            <thead>
                <tr>
                    <th>T√™n S·∫£n Ph·∫©m</th>
                    <th>S·ªë L∆∞·ª£ng</th>
                    <th>ƒê∆°n Gi√°</th>
                    <th>Th√†nh Ti·ªÅn</th>
                </tr>
            </thead>
            <tbody id="itemsTableBody">
                </tbody>
        </table>

        <div class="totals-section">
            <table>
                <tr>
                    <td class="label">T·ªïng ti·ªÅn h√†ng:</td>
                    <td id="tongTienHang"></td>
                </tr>
                <tr>
                    <td class="label">Chi·∫øt kh·∫•u:</td>
                    <td id="chietKhau"></td>
                </tr>
                <tr>
                    <td class="label total-amount">KH√ÅCH C·∫¶N TR·∫¢:</td>
                    <td class="total-amount" id="khachCanTra"></td>
                </tr>
            </table>
        </div>

        <div class="footer">
            <p>C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ mua h√†ng!</p>
        </div>
    </div>

    <div class="buttons">
        <button class="btn" onclick="printForm()">üñ®Ô∏è In H√≥a ƒê∆°n</button>
        <button class="btn btn-success" onclick="exportToPDF()">üìÑ Xu·∫•t PDF</button>
        <button class="btn btn-info" onclick="exportToImage()">üñºÔ∏è Xu·∫•t h√¨nh ·∫£nh</button>
    </div>

    <script>
        // H√†m l·∫•y tham s·ªë t·ª´ URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name) || '';
        }

        // H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá Vi·ªát Nam
        function formatCurrency(amount) {
            if (!amount) return '0';
            return parseFloat(amount).toLocaleString('vi-VN') + ' ƒë';
        }

        // H√†m ƒë·ªãnh d·∫°ng ng√†y th√°ng
        function formatDate(dateString) {
            if (!dateString) return '';
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', options);
        }

        // H√†m t·∫£i d·ªØ li·ªáu chi ti·∫øt s·∫£n ph·∫©m
        function loadItemsData() {
            const tbody = document.getElementById('itemsTableBody');
            tbody.innerHTML = '';
            let items = [];
            const itemsJson = getUrlParameter('items');

            if (itemsJson) {
                try {
                    items = JSON.parse(decodeURIComponent(itemsJson));
                } catch (e) {
                    console.error('L·ªói x·ª≠ l√Ω JSON chi ti·∫øt s·∫£n ph·∫©m:', e);
                    tbody.innerHTML = '<tr><td colspan="4">Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng.</td></tr>';
                    return;
                }
            }
            
            if (items.length > 0) {
                items.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.tenSP || ''}</td>
                        <td>${item.soLuong || 0}</td>
                        <td>${formatCurrency(item.donGia)}</td>
                        <td>${formatCurrency(item.thanhTien)}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                 tbody.innerHTML = '<tr><td colspan="4">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o.</td></tr>';
            }
        }

        // H√†m t·∫£i to√†n b·ªô d·ªØ li·ªáu t·ª´ URL v√†o trang
        function loadDataFromUrl() {
            // Th√¥ng tin h√≥a ƒë∆°n
            document.getElementById('maHoaDon').textContent = getUrlParameter('maDonHang');
            document.getElementById('ngayMua').textContent = formatDate(getUrlParameter('ngayMua'));

            // Th√¥ng tin kh√°ch h√†ng
            document.getElementById('tenKH').textContent = getUrlParameter('tenKH');
            document.getElementById('sdtKH').textContent = getUrlParameter('sdtKH');
            document.getElementById('diaChiKH').textContent = getUrlParameter('diaChiKH');

            // T·ªïng ti·ªÅn
            document.getElementById('tongTienHang').textContent = formatCurrency(getUrlParameter('tongTien'));
            document.getElementById('chietKhau').textContent = formatCurrency(getUrlParameter('chietKhau'));
            document.getElementById('khachCanTra').textContent = formatCurrency(getUrlParameter('thanhTien'));
            
            // T·∫£i danh s√°ch s·∫£n ph·∫©m
            loadItemsData();
        }

        // C√°c h√†m ch·ª©c nƒÉng in, xu·∫•t file
        function printForm() { window.print(); }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('printArea');
            const fileName = `Hoa_don_${getUrlParameter('maDonHang') || 'moi'}.pdf`;

            html2canvas(element, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(fileName);
            });
        }

        function exportToImage() {
            const element = document.getElementById('printArea');
            const fileName = `Hoa_don_${getUrlParameter('maDonHang') || 'moi'}.png`;

            html2canvas(element, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = fileName;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        // T·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c m·ªü
        window.onload = loadDataFromUrl;
    </script>
</body>
</html>
